name: Deploy (Terraform + ECR + EC2)

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs: # Exposes outputs producesd by a (later) step in this job so that downstream jobs can use them, akin to return vals of a function
      ecr_repo_url: ${{ steps.tfout.outputs.ecr_repo_url }}
      ec2_dns: ${{ steps.tfout.outputs.ec2_dns }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3 # This step installs and configures Terraform itself on the GitHub Actions runner so that later steps can run terraform init, terraform apply, etc.

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: basic_infra/infrastructure
        run: terraform init

      - name: Terraform Apply
        working-directory: basic_infra/infrastructure
        env:
          TF_VAR_ALLOWED_SSH_CIDR: ${{ secrets.TF_VAR_ALLOWED_SSH_CIDR }}
          TF_VAR_TV_WEBHOOK_SECRET: ${{ secrets.TF_VAR_TV_WEBHOOK_SECRET }}
        run: terraform apply -auto-approve

      - name: Read Terraform outputs
        id: tfout
        working-directory: basic_infra/infrastructure
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "ecr_repo_url=$(terraform output -raw ecr_repo_url)" >> $GITHUB_OUTPUT
          echo "ec2_dns=$(terraform output -json ec2_public_dns | jq -r '.[0]')" >> $GITHUB_OUTPUT

  build_push_deploy:
    runs-on: ubuntu-latest
    needs: terraform # Depends on the last job terraform
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
                      
      - name: Build & Push image to ECR
        working-directory: app
        run: |
          IMAGE="${{ needs.terraform.outputs.ecr_repo_url }}:latest"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy on EC2 (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.terraform.outputs.ec2_dns }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_REGION
          script: |
            set -euo pipefail

            # Ensure awscli exists on the host so we can auth Docker to ECR
            if ! command -v aws >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y awscli
            fi

            ECR_REPO="${{ needs.terraform.outputs.ecr_repo_url }}"
            REGISTRY="$(echo "$ECR_REPO" | cut -d/ -f1)"

            # Login Docker to ECR, pull latest image, restart service
            aws ecr get-login-password --region "${AWS_REGION}" \
              | sudo docker login --username AWS --password-stdin "$REGISTRY"

            sudo docker pull "${ECR_REPO}:latest"
            sudo systemctl restart tv-webhook.service
            sudo systemctl --no-pager status tv-webhook.service

            sudo nginx -t
            sudo systemctl reload nginx
