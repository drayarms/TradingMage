name: Deploy (Terraform + ECR + EC2)

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs: # Exposes outputs producesd by a (later) step in this job so that downstream jobs can use them, akin to return vals of a function
      ecr_repo_url: ${{ steps.tfout.outputs.ecr_repo_url }}
      ec2_ip: ${{ steps.tfout.outputs.ec2_ip }}
      #ec2_dns: ${{ steps.tfout.outputs.ec2_dns }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3 # This step installs and configures Terraform itself on the GitHub Actions runner so that later steps can run terraform init, terraform apply, etc.

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: basic_infra/infrastructure
        run: terraform init

      - name: Terraform Apply
        working-directory: basic_infra/infrastructure
        env:
          TF_VAR_allowed_ssh_cidr: ${{ secrets.TF_VAR_ALLOWED_SSH_CIDR }} # Assigned to allowed_ssh_cidr
          TF_VAR_tv_webhook_secret: ${{ secrets.TF_VAR_TV_WEBHOOK_SECRET }} # Assigned to tv_webhook_secret
        run: terraform apply -auto-approve -input=false # input=false forces TF to fail fast instead of waiting for an input shold an error occur

      - name: Read Terraform outputs
        id: tfout
        working-directory: basic_infra/infrastructure
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "ecr_repo_url=$(terraform output -raw ecr_repo_url)" >> $GITHUB_OUTPUT
          echo "ec2_ip=$(terraform output -json ec2_public_ips | jq -r '.[0]')" >> $GITHUB_OUTPUT 

      - name: Debug Terraform outputs
        run: |
          echo "ECR URL = '${{ steps.tfout.outputs.ecr_repo_url }}'"
          echo "EC2 IP = '${{ steps.tfout.outputs.ec2_ip }}'"

  build_push_deploy:
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # Read Terraform outputs independently (from remote state)
      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (read outputs)
        working-directory: basic_infra/infrastructure
        run: terraform init -input=false

      - name: Read infra outputs (ECR + EC2 IP)
        id: infraout
        working-directory: basic_infra/infrastructure
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "ecr_repo_url=$(terraform output -raw ecr_repo_url)" >> $GITHUB_OUTPUT
          echo "ec2_ip=$(terraform output -json ec2_public_ips | jq -r '.[0]')" >> $GITHUB_OUTPUT

      - name: Debug infra outputs
        run: |
          echo "ECR='${{ steps.infraout.outputs.ecr_repo_url }}'"
          echo "EC2_IP='${{ steps.infraout.outputs.ec2_ip }}'"

      - name: Build & Push image to ECR
        working-directory: app
        run: |
          set -euo pipefail

          ECR="${{ steps.infraout.outputs.ecr_repo_url }}"
          if [ -z "$ECR" ]; then
            echo "ERROR: ecr_repo_url is empty"
            exit 1
          fi

          IMAGE="$ECR:latest"
          echo "Building image: $IMAGE"

          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy on EC2 (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.infraout.outputs.ec2_ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          passphrase: ${{ secrets.EC2_SSH_KEY_PASSPHRASE }}
          envs: AWS_REGION
          script: |
            set -euo pipefail

            # Ensure awscli exists on the host so we can auth Docker to ECR
            if ! command -v aws >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y awscli
            fi

            ECR_REPO="${{ steps.infraout.outputs.ecr_repo_url }}"
            REGISTRY="$(echo "$ECR_REPO" | cut -d/ -f1)"

            aws ecr get-login-password --region "${AWS_REGION}" \
              | sudo docker login --username AWS --password-stdin "$REGISTRY"

            sudo docker pull "${ECR_REPO}:latest"
            sudo systemctl restart tv-webhook.service
            sudo systemctl --no-pager status tv-webhook.service

            sudo nginx -t
            sudo systemctl reload nginx